config {
  type: "incremental",
  database: "my-agentic-dataops",
  schema: "silver",
  name: "orders_clean",
  bigquery: { partitionBy: "DATE(order_ts)", clusterBy: ["customer_id"] },
  tags: ["daily","silver"]
}

SELECT
  CAST(order_id AS STRING)    AS order_id,
  CAST(customer_id AS STRING) AS customer_id,
  TIMESTAMP(order_ts)         AS order_ts,
  LOWER(status)               AS status,
  UPPER(currency)             AS currency,
  CAST(amount AS NUMERIC)     AS amount
FROM `my-agentic-dataops.bronze.orders_raw`
WHERE TRUE
  ${ when(incremental(), "AND DATE(order_ts) >= DATE_SUB(CURRENT_DATE(), INTERVAL 7 DAY)") }
QUALIFY ROW_NUMBER() OVER (PARTITION BY order_id ORDER BY order_ts DESC) = 1